# Project Structure

## å½“å‰å®ç°çŠ¶æ€
âœ… = å·²å®ç°  ğŸš§ = éƒ¨åˆ†å®ç°  ğŸ“‹ = è®¡åˆ’ä¸­

```
Cholecyst-and-Instrument-Segmentation-Model/
â”œâ”€ README.md                          # âœ… é¡¹ç›®ç®€ä»‹
â”œâ”€ LICENSE                            # âœ… è®¸å¯è¯å£°æ˜
â”œâ”€ PROJECT_STRUCTURE.md               # âœ… é¡¹ç›®ç»“æ„æ–‡æ¡£
â”œâ”€ requirements.txt                   # ğŸ“‹ Pythonä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€ pyproject.toml                     # ğŸ“‹ å¯é€‰ï¼šPythonæ‰“åŒ…é…ç½®
â”œâ”€ .gitignore                         # âœ… Gitå¿½ç•¥æ–‡ä»¶åˆ—è¡¨
â”‚
â”œâ”€ configs/                           # âœ… YAMLé…ç½®æ–‡ä»¶ï¼Œç»Ÿä¸€ç®¡ç†å‚æ•°ï¼ˆSingle Source of Truthï¼‰
â”‚  â”œâ”€ universal_template_config.yaml # âœ… é€šç”¨è®­ç»ƒæ¨¡æ¿é…ç½®
â”‚  â”œâ”€ datasets/                       # ğŸš§ æ•°æ®é›†é…ç½®ç›®å½•
â”‚  â”‚  â”œâ”€ cholec80.yaml               # ğŸ“‹ Cholec80æ•°æ®é›†è·¯å¾„ä¸å‚æ•°
â”‚  â”‚  â””â”€ endovis.yaml                # ğŸ“‹ EndoVisæ•°æ®é›†è·¯å¾„ä¸å‚æ•°
â”‚  â”œâ”€ offline/                        # ğŸš§ ç¦»çº¿é˜¶æ®µï¼ˆé‡æ¨¡å‹è®­ç»ƒï¼‰å‚æ•°ç›®å½•
â”‚  â”‚  â”œâ”€ baseline_min.yaml           # ğŸ“‹ æç®€é…ç½®ï¼ˆå¯é€‰ï¼Œä¸æƒ³é…ä¹Ÿå¯ç”¨å‘½ä»¤è¡Œï¼‰
â”‚  â”‚  â”œâ”€ unetpp_deeplabv3.yaml       # ğŸ“‹ U-Net++å’ŒDeepLabV3é…ç½®
â”‚  â”‚  â””â”€ hrnet.yaml                  # ğŸ“‹ HRNeté…ç½®
â”‚  â”œâ”€ online/                         # ğŸš§ åœ¨çº¿é˜¶æ®µï¼ˆè½»é‡æ¨¡å‹ä¸è‡ªé€‚åº”ï¼‰å‚æ•°ç›®å½•
â”‚  â”‚  â”œâ”€ default_online.yaml         # ğŸ“‹ é»˜è®¤åœ¨çº¿æ¨ç†å‚æ•°ï¼ˆé˜ˆå€¼ã€æ»‘çª—å¤§å°ç­‰ï¼‰
â”‚  â”‚  â”œâ”€ gating.yaml                 # ğŸ“‹ å¤šä¿¡å·æƒé‡é…ç½®
â”‚  â”‚  â”œâ”€ conservative_update.yaml     # ğŸ“‹ BN-only / Decoder-lite / Adapter-onlyé…ç½®
â”‚  â”‚  â”œâ”€ buffer_trio.yaml            # ğŸ“‹ ç¼“å†²æœºåˆ¶ï¼ˆè¿Ÿæ»ã€å†·å´ã€å›æ»šï¼‰
â”‚  â”‚  â””â”€ escalation.yaml             # ğŸ“‹ å®‰å…¨æ¨¡å¼åˆ‡æ¢è§„åˆ™
â”‚  â””â”€ ablations/                      # ğŸš§ æ¶ˆèå®éªŒé…ç½®ç›®å½•
â”‚     â”œâ”€ offline_only.yaml           # ğŸ“‹ ä»…ç¦»çº¿æ¨¡å‹
â”‚     â”œâ”€ online_naive.yaml           # ğŸ“‹ ç®€å•åœ¨çº¿æ›´æ–°
â”‚     â”œâ”€ no_entropy_gate.yaml        # ğŸ“‹ æ— ç†µé—¨æ§
â”‚     â”œâ”€ no_buffer_trio.yaml         # ğŸ“‹ æ— ç¼“å†²æœºåˆ¶
â”‚     â””â”€ bn_only.yaml                # ğŸ“‹ ä»…BNæ›´æ–°
â”‚
â”œâ”€ data/                              # âœ… æ•°æ®é›†å…ƒä¿¡æ¯æˆ–è½¯é“¾æ¥ï¼ˆåŸæ•°æ®ä¸æ”¾å…¥ä»“åº“ï¼‰
â”‚  â””â”€ README.md                      # ğŸ“‹ æ•°æ®æŒ‚è½½è¯´æ˜
â”‚
â”œâ”€ checkpoints/                       # âœ… æ¨¡å‹æƒé‡ï¼ˆç¦»çº¿é‡æ¨¡å‹ã€è’¸é¦æ¨¡å‹ã€EMAå¿«ç…§ï¼‰
â”‚
â”œâ”€ logs/                              # âœ… æ—¥å¿—ï¼ˆtensorboardã€JSONã€äº‹ä»¶è¿½è¸ªï¼‰
â”‚
â”œâ”€ outputs/                           # âœ… æ¨ç†ç»“æœã€å¯è§†åŒ–ã€è¡¨æ ¼
â”‚
â”œâ”€ docs/                              # âœ… æ–‡æ¡£ä¸å›¾è¡¨
â”‚  â”œâ”€ UNIVERSAL_TEMPLATE_GUIDE.md    # âœ… é€šç”¨è®­ç»ƒæ¨¡æ¿ä½¿ç”¨æŒ‡å—
â”‚  â”œâ”€ diagrams/                      # âœ… Mermaidæµç¨‹å›¾ç›®å½•
â”‚  â”œâ”€ method_notes.md                # ğŸ“‹ æ–¹æ³•è®°å½•ã€è°ƒå‚ç¬”è®°
â”‚  â””â”€ experiments_template.md        # ğŸ“‹ å®éªŒæŠ¥å‘Šæ¨¡æ¿
â”‚
â”œâ”€ scripts/                           # âœ… å‘½ä»¤è¡Œè„šæœ¬ï¼ˆå¯å¤ç°è¿è¡Œï¼‰
â”‚  â”œâ”€ seg8k_fetch.py                 # âœ… æ•°æ®é›†ä¸‹è½½è„šæœ¬
â”‚  â”œâ”€ demo_multiclass_color.py       # âœ… å¤šç±»åˆ†å‰²å¯è§†åŒ–æ¼”ç¤ºè„šæœ¬
â”‚  â”œâ”€ train_monitor.py               # âœ… è®­ç»ƒç›‘æ§æ¨¡å—ï¼ˆå·²ç§»è‡³src/common/ï¼‰
â”‚  â”œâ”€ train_offline.sh               # ğŸ“‹ ç¦»çº¿è®­ç»ƒå…¥å£
â”‚  â”œâ”€ distill.sh                     # ğŸ“‹ é‡â†’è½»è’¸é¦
â”‚  â”œâ”€ export_onnx.sh                 # ğŸ“‹ å¯¼å‡ºONNXæ¨¡å‹ï¼ˆTRTåŠ é€Ÿï¼‰
â”‚  â”œâ”€ run_online.sh                  # ğŸ“‹ åœ¨çº¿æ¨ç†å…¥å£
â”‚  â”œâ”€ ablation_suite.sh              # ğŸ“‹ æ‰¹é‡è¿è¡Œæ¶ˆèå®éªŒ
â”‚  â””â”€ eval_offline.sh                # ğŸ“‹ ç¦»çº¿æ¨¡å‹éªŒè¯
â”‚
â”œâ”€ notebooks/                         # âœ… Jupyterå®éªŒç¬”è®°
â”‚  â”œâ”€ 01_data_checks.ipynb           # ğŸ“‹ æ•°æ®æ£€æŸ¥
â”‚  â”œâ”€ 02_entropy_threshold_sweep.ipynb # ğŸ“‹ ç†µé˜ˆå€¼è°ƒä¼˜
â”‚  â””â”€ 03_runtime_budget.ipynb        # ğŸ“‹ è¿è¡Œæ—¶èµ„æºè¯„ä¼°
â”‚
â”œâ”€ docker/                            # âœ… Dockerç¯å¢ƒ
â”‚  â”œâ”€ environment.yml                # âœ… Condaç¯å¢ƒé…ç½®
â”‚  â””â”€ Dockerfile                     # ğŸ“‹ å®¹å™¨æ„å»ºæ–‡ä»¶
â”‚
â”œâ”€ tests/                             # âœ… æ ¸å¿ƒåŠŸèƒ½å•å…ƒæµ‹è¯•ç›®å½•
â”‚  â”œâ”€ test_entropy.py                # ğŸ“‹ ç†µè®¡ç®—æµ‹è¯•
â”‚  â”œâ”€ test_gating.py                 # ğŸ“‹ é—¨æ§é€»è¾‘æµ‹è¯•
â”‚  â”œâ”€ test_hysteresis.py             # ğŸ“‹ è¿Ÿæ»æœºåˆ¶æµ‹è¯•
â”‚  â”œâ”€ test_rollback.py               # ğŸ“‹ å›æ»šæœºåˆ¶æµ‹è¯•
â”‚  â””â”€ test_pseudo_labels.py          # ğŸ“‹ ä¼ªæ ‡ç­¾ç”Ÿæˆæµ‹è¯•
â”‚
â”œâ”€ src/                               # âœ… æ ¸å¿ƒæºä»£ç 
   â”œâ”€ common/                        # âœ… å…¬å…±å·¥å…·
   â”‚  â”œâ”€ constants.py                # âœ… å…¨å±€å¸¸é‡å®šä¹‰ï¼ˆCLASSESã€PALETTEã€IGNORE_INDEXï¼‰
   â”‚  â”œâ”€ output_manager.py           # âœ… è¾“å‡ºç›®å½•ç®¡ç†å’Œç»“æœä¿å­˜
   â”‚  â””â”€ train_monitor.py            # âœ… è®­ç»ƒç›‘æ§æ¨¡å—ï¼ˆå•è¡Œåˆ·æ–°ã€GPUç›‘æ§ã€è¿›åº¦æ¡ã€ETAé¢„ä¼°ï¼‰
   â”œâ”€ dataio/                        # âœ… æ•°æ®åŠ è½½ä¸é¢„å¤„ç†
   â”‚  â””â”€ datasets/                   # âœ… æ•°æ®é›†ç±»
   â”‚     â””â”€ seg_dataset_min.py       # âœ… æœ€å°æ•°æ®é›†ç±»ï¼ˆimages/ã€masks/ï¼‰
   â”œâ”€ models/                        # âœ… æ¨¡å‹ç»“æ„
   â”‚  â”œâ”€ model_zoo.py                # âœ… æ¨¡å‹åŠ¨ç‰©å›­ï¼ˆç»Ÿä¸€æ¨¡å‹æ„å»ºå’Œç®¡ç†ï¼‰
   â”‚  â”œâ”€ baseline/                   # âœ… åŸºçº¿æ¨¡å‹
   â”‚  â”‚  â””â”€ unet_min.py              # âœ… æœ€å° U-Net
   â”‚  â”œâ”€ offline/                    # âœ… ç¦»çº¿é‡æ¨¡å‹ç›®å½•ï¼ˆé¢„ç•™ï¼‰
   â”‚  â””â”€ online/                     # âœ… åœ¨çº¿/è½»é‡æ¨¡å‹
   â”‚     â”œâ”€ mobile_unet.py           # âœ… MobileNeté£æ ¼çš„è½»é‡U-Netï¼ˆæ·±åº¦å¯åˆ†ç¦»å·ç§¯ï¼‰
   â”‚     â””â”€ adaptive_unet.py         # âœ… è‡ªé€‚åº”U-Netï¼ˆå¸¦é€‚é…å™¨å±‚ï¼Œæ”¯æŒåœ¨çº¿å­¦ä¹ ï¼‰
   â”œâ”€ training/                      # âœ… è®­ç»ƒæµç¨‹
   â”‚  â”œâ”€ offline/                    # âœ… ç¦»çº¿è®­ç»ƒæ¨¡å—
   â”‚  â”‚  â”œâ”€ train_offline_min.py     # âœ… æœ€å°ç¦»çº¿è®­ç»ƒï¼ˆ1ä¸ªepochæµ‹è¯•ï¼‰+ ğŸ”„ å¯é›†æˆç›‘æ§
   â”‚  â”‚  â””â”€ train_offline_universal.py # âœ… é€šç”¨ç¦»çº¿è®­ç»ƒæ¨¡æ¿ï¼ˆé›†æˆç›‘æ§ã€å¯è§†åŒ–ã€è¯„ä¼°ï¼‰
   â”‚  â””â”€ online/                     # âœ… åœ¨çº¿è®­ç»ƒæ¨¡å—
   â”‚     â””â”€ adaptive_unet_main.py    # âœ… åœ¨çº¿è‡ªé€‚åº”å­¦ä¹ ä¸»ç¨‹åºï¼ˆå¸§é€‰æ‹©ã€ç»éªŒå›æ”¾ã€åœ¨çº¿è®­ç»ƒï¼‰
   â”œâ”€ eval/                          # âœ… è¯„ä¼°æ¨¡å—
   â”‚  â””â”€ evaluator.py                # âœ… åˆ†å‰²æŒ‡æ ‡è¯„ä¼°å™¨ï¼ˆIoUã€Diceã€Accuracyç­‰ï¼‰
   â”œâ”€ online/                        # ğŸ“‹ åœ¨çº¿æ¨ç†ä¸è‡ªé€‚åº”ï¼ˆé¢„ç•™ç›®å½•ï¼‰
   â””â”€ viz/                          # âœ… å¯è§†åŒ–å·¥å…·
      â”œâ”€ colorize.py                 # âœ… é¢œè‰²æ˜ å°„å’Œå¯è§†åŒ–å‡½æ•°ï¼ˆid_to_colorã€make_tripletã€overlayï¼‰
      â””â”€ visualizer.py               # âœ… å¯è§†åŒ–å™¨ï¼ˆé¢„æµ‹ç»“æœã€å åŠ å›¾åƒï¼‰
```

## æ–°å¢åŠŸèƒ½æ¨¡å—è¯´æ˜

### ğŸ†• é€šç”¨è®­ç»ƒæ¨¡æ¿ (`src/training/offline/train_offline_universal.py`)
- **åŠŸèƒ½**: é›†æˆç›‘æ§ã€å¯è§†åŒ–ã€è¯„ä¼°çš„é€šç”¨è®­ç»ƒæ¡†æ¶
- **ç‰¹ç‚¹**: 
  - å®æ—¶è¿›åº¦ç›‘æ§ï¼ˆå•è¡Œåˆ·æ–°ï¼‰
  - GPUä½¿ç”¨ç‡å’Œå†…å­˜ç›‘æ§
  - è‡ªåŠ¨æ¨¡å‹ä¿å­˜å’ŒæŒ‡æ ‡è®°å½•
  - å¯è§†åŒ–ç»“æœè‡ªåŠ¨ç”Ÿæˆ
  - æ˜“äºé€‚é…ä¸åŒæ¨¡å‹æ¶æ„
  - æ”¯æŒäºŒåˆ†ç±»å’Œå¤šåˆ†ç±»åˆ†å‰²ä»»åŠ¡
  - æ¨¡å‹æ’æ‹”æœºåˆ¶ï¼ˆé€šè¿‡model_zooç»Ÿä¸€ç®¡ç†ï¼‰

### ğŸ†• è®­ç»ƒç›‘æ§æ¨¡å— (`src/common/train_monitor.py`)
- **åŠŸèƒ½**: æä¾›è®­ç»ƒè¿‡ç¨‹çš„å®æ—¶ç›‘æ§å’ŒçŠ¶æ€æ˜¾ç¤º
- **ç‰¹ç‚¹**:
  - å•è¡Œåˆ·æ–°è¿›åº¦æ˜¾ç¤º
  - CPU/GPUèµ„æºç›‘æ§
  - è®­ç»ƒæ—¶é—´ç»Ÿè®¡å’ŒETAå‰©ä½™æ—¶é—´é¢„ä¼°
  - Epochæ€»ç»“æŠ¥å‘Š
  - æ™ºèƒ½è¿›åº¦ç®—æ³•ï¼ˆåŸºäºå·²å®Œæˆbatchå’Œepochè®¡ç®—å‰©ä½™æ—¶é—´ï¼‰
- **é›†æˆ**: å¯ç›´æ¥é›†æˆåˆ°ç°æœ‰è®­ç»ƒè„šæœ¬ä¸­ï¼ŒåŒ…æ‹¬`train_offline_min.py`

### ğŸ†• è¾“å‡ºç®¡ç†å™¨ (`src/common/output_manager.py`)
- **åŠŸèƒ½**: ç»Ÿä¸€ç®¡ç†è®­ç»ƒè¾“å‡ºã€æ¨¡å‹ä¿å­˜å’Œç»“æœç»„ç»‡
- **ç‰¹ç‚¹**:
  - è‡ªåŠ¨åˆ›å»ºæ—¶é—´æˆ³ç›®å½•
  - CSVæŒ‡æ ‡è®°å½•
  - æ¨¡å‹æ£€æŸ¥ç‚¹ç®¡ç†
  - é…ç½®æ–‡ä»¶ä¿å­˜

### ğŸ†• è¯„ä¼°å™¨ (`src/eval/evaluator.py`)
- **åŠŸèƒ½**: æä¾›åˆ†å‰²ä»»åŠ¡çš„æ ‡å‡†è¯„ä¼°æŒ‡æ ‡
- **æ”¯æŒæŒ‡æ ‡**: IoUã€Diceã€Accuracyã€Precisionã€Recall
- **ç‰¹ç‚¹**: æ”¯æŒäºŒåˆ†ç±»å’Œå¤šåˆ†ç±»åˆ†å‰²
- **é¢„ç•™æ¥å£**: è‡ªåŠ¨æ£€æµ‹ä»»åŠ¡ç±»å‹ã€é€šç”¨è¯„ä¼°ã€é«˜çº§æŒ‡æ ‡è®¡ç®—

### ğŸ†• å¯è§†åŒ–å™¨ (`src/viz/visualizer.py`)
- **åŠŸèƒ½**: ç”Ÿæˆè®­ç»ƒå’ŒéªŒè¯ç»“æœçš„å¯è§†åŒ–
- **è¾“å‡º**: é¢„æµ‹æ©ç ã€å åŠ å›¾åƒã€å¯¹æ¯”å›¾
- **æ‰©å±•æ¥å£**: é¢„ç•™å¤šé¢æ¿å¯è§†åŒ–ã€æŒ‡æ ‡æ›²çº¿ç­‰åŠŸèƒ½

### ğŸ†• é¢œè‰²æ˜ å°„æ¨¡å— (`src/viz/colorize.py`)
- **åŠŸèƒ½**: æä¾›åˆ†å‰²æ©ç çš„é¢œè‰²æ˜ å°„å’Œå¯è§†åŒ–å‡½æ•°
- **ç‰¹ç‚¹**:
  - `id_to_color()`: å°†åˆ†å‰²IDè½¬æ¢ä¸ºå½©è‰²å›¾åƒ
  - `make_triplet()`: åˆ›å»ºåŸå›¾-çœŸå€¼-é¢„æµ‹çš„ä¸‰è”å¯¹æ¯”å›¾
  - `overlay()`: åœ¨åŸå›¾ä¸Šå åŠ åŠé€æ˜åˆ†å‰²ç»“æœ
- **åº”ç”¨**: ç”¨äºæ¼”ç¤ºè„šæœ¬å’Œè®­ç»ƒå¯è§†åŒ–

### ğŸ†• æ”¹è¿›è®­ç»ƒé…ç½® (`improved_training_config.py`)
- **åŠŸèƒ½**: æä¾›æ”¹è¿›çš„è®­ç»ƒç­–ç•¥å’Œé…ç½®å»ºè®®
- **ç‰¹ç‚¹**:
  - åŠ æƒBCEæŸå¤±å‡½æ•°å¤„ç†ç±»åˆ«ä¸å¹³è¡¡
  - ä¼˜åŒ–çš„è¶…å‚æ•°é…ç½®ï¼ˆå­¦ä¹ ç‡ã€batch sizeã€epochsï¼‰
  - Cosineå­¦ä¹ ç‡è°ƒåº¦å’Œwarmupç­–ç•¥
  - æ•°æ®å¢å¼ºé…ç½®å»ºè®®
- **åº”ç”¨**: æŒ‡å¯¼è®­ç»ƒå‚æ•°è°ƒä¼˜å’Œæ€§èƒ½æå‡

### ğŸ†• æ¨¡å‹åŠ¨ç‰©å›­ (`src/models/model_zoo.py`)
- **åŠŸèƒ½**: ç»Ÿä¸€çš„æ¨¡å‹æ„å»ºå’Œç®¡ç†ä¸­å¿ƒ
- **ç‰¹ç‚¹**:
  - ä¸­å¿ƒåŒ–æ¨¡å‹æ³¨å†Œå’Œå®ä¾‹åŒ–
  - æ”¯æŒäºŒåˆ†ç±»å’Œå¤šåˆ†ç±»åˆ†å‰²ä»»åŠ¡è‡ªåŠ¨é€‚é…
  - æ¨¡å‹å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†
  - Fallbackæœºåˆ¶ç¡®ä¿æ¨¡å‹å¯ç”¨æ€§
  - é›†æˆè°ƒè¯•æ—¥å¿—ç”¨äºé—®é¢˜è¯Šæ–­
- **æ”¯æŒæ¨¡å‹**: UNetMin, MobileUNet, AdaptiveUNet
- **åº”ç”¨**: è®­ç»ƒè„šæœ¬ä¸­çš„æ¨¡å‹æ’æ‹”å’Œåˆ‡æ¢

### ğŸ†• æ¨¡å‹æ³¨å†Œè¡¨ (`src/common/model_registry.py`)
- **åŠŸèƒ½**: æ¨¡å‹åç§°åˆ°ç±»çš„æ˜ å°„ç®¡ç†
- **ç‰¹ç‚¹**:
  - å»è€¦åˆçš„æ¨¡å‹æ³¨å†Œæœºåˆ¶
  - ä¾¿äºæ‰©å±•æ–°æ¨¡å‹ç±»å‹
  - ç»Ÿä¸€çš„æ¨¡å‹è®¿é—®æ¥å£
- **é›†æˆ**: ä¸model_zoo.pyååŒå·¥ä½œ
- **åŠŸèƒ½**: ç»Ÿä¸€ç®¡ç†é¡¹ç›®å…¨å±€å¸¸é‡å’Œé…ç½®
- **å†…å®¹**:
  - `CLASSES`: ç±»åˆ«IDåˆ°åç§°çš„æ˜ å°„ï¼ˆbackground, instrument, target_organç­‰ï¼‰
  - `PALETTE`: ç±»åˆ«IDåˆ°RGBé¢œè‰²çš„æ˜ å°„
  - `IGNORE_INDEX`: å¿½ç•¥æ ‡ç­¾çš„ç´¢å¼•å€¼
- **ä¼˜åŠ¿**: ä¸­å¿ƒåŒ–é…ç½®ï¼Œä¾¿äºç»´æŠ¤å’Œä¿®æ”¹

### ğŸ†• MobileUNetæ¨¡å‹ (`src/models/online/mobile_unet.py`)
- **åŠŸèƒ½**: è½»é‡çº§åˆ†å‰²æ¨¡å‹ï¼Œé€‚ç”¨äºåœ¨çº¿æ¨ç†
- **ç‰¹ç‚¹**:
  - é‡‡ç”¨æ·±åº¦å¯åˆ†ç¦»å·ç§¯ï¼ˆDepthwiseSeparableConvï¼‰
  - å¤§å¹…å‡å°‘å‚æ•°é‡å’Œè®¡ç®—é‡
  - ä¿æŒU-Netæ¶æ„çš„è·³è·ƒè¿æ¥è®¾è®¡
- **åº”ç”¨**: ç§»åŠ¨è®¾å¤‡éƒ¨ç½²ã€å®æ—¶æ¨ç†åœºæ™¯

### ğŸ†• è‡ªé€‚åº”UNetæ¨¡å‹ (`src/models/online/adaptive_unet.py`)
- **åŠŸèƒ½**: æ”¯æŒåœ¨çº¿å­¦ä¹ çš„è‡ªé€‚åº”åˆ†å‰²æ¨¡å‹
- **ç‰¹ç‚¹**:
  - å†…ç½®ConvAdapteré€‚é…å™¨å±‚ï¼Œæ”¯æŒå¿«é€Ÿé€‚åº”æ–°æ•°æ®åˆ†å¸ƒ
  - å¯é€‰æ‹©æ€§å†»ç»“ç¼–ç å™¨/è§£ç å™¨ï¼Œåªè®­ç»ƒé€‚é…å™¨å‚æ•°
  - ä¿æŒåŸæœ‰U-Netä¸»å¹²ç»“æ„çš„ç¨³å®šæ€§
- **ä¼˜åŠ¿**: åœ¨çº¿å­¦ä¹ æ—¶è®¡ç®—å¼€é”€å°ï¼Œé€‚åº”é€Ÿåº¦å¿«

### ğŸ†• åœ¨çº¿è‡ªé€‚åº”å­¦ä¹ ç³»ç»Ÿ (`src/online/adaptive_unet_main.py`)
- **åŠŸèƒ½**: å®Œæ•´çš„åœ¨çº¿å­¦ä¹ æ¡†æ¶ï¼Œæ”¯æŒå®æ—¶æ•°æ®é€‚åº”
- **æ ¸å¿ƒç»„ä»¶**:
  - **FrameSelector**: æ™ºèƒ½å¸§é€‰æ‹©å™¨ï¼ŒåŸºäºSSIMç›¸ä¼¼åº¦å†³å®šå¤„ç†ç­–ç•¥
  - **ExperienceReplayBuffer**: ç»éªŒå›æ”¾ç¼“å†²åŒºï¼Œé˜²æ­¢ç¾éš¾æ€§é—å¿˜
  - **OnlineLearner**: åœ¨çº¿å­¦ä¹ ç®¡ç†å™¨ï¼Œåè°ƒæ¨¡å‹è®­ç»ƒå’Œæ•°æ®ç®¡ç†
- **ç‰¹ç‚¹**:
  - è‡ªé€‚åº”é˜ˆå€¼è°ƒæ•´
  - å¸§é—´ç›¸ä¼¼åº¦åˆ†æï¼ˆé«˜ç›¸ä¼¼åº¦æ—¶ä»…å¤„ç†ä¸­é—´å¸§ï¼‰
  - å†å²æ•°æ®å›æ”¾æœºåˆ¶
  - æ¢¯åº¦è£å‰ªå’Œå­¦ä¹ ç‡è°ƒåº¦
- **åº”ç”¨**: æ‰‹æœ¯è§†é¢‘å®æ—¶åˆ†å‰²ã€åŠ¨æ€åœºæ™¯é€‚åº”

### ğŸ†• å¤šç±»åˆ†å‰²æ¼”ç¤ºè„šæœ¬ (`scripts/demo_multiclass_color.py`)
- **åŠŸèƒ½**: å±•ç¤ºå¤šç±»åˆ†å‰²æ¨¡å‹çš„æ¨ç†å’Œå¯è§†åŒ–æ•ˆæœ
- **ç‰¹ç‚¹**:
  - æ”¯æŒåŠ è½½é¢„è®­ç»ƒæ¨¡å‹è¿›è¡Œæ¨ç†
  - å¯é€‰æ‹©æä¾›çœŸå€¼æ ‡ç­¾ç”Ÿæˆä¸‰è”å¯¹æ¯”å›¾
  - è¾“å‡ºå½©è‰²å¯è§†åŒ–ç»“æœ
- **ç”¨æ³•**: ç”¨äºæ¨¡å‹æ•ˆæœæ¼”ç¤ºå’Œç»“æœéªŒè¯

## ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹
```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate tti-seg-py310

# ä½¿ç”¨é€šç”¨æ¨¡æ¿è®­ç»ƒ
python src/training/offline/train_offline_universal.py \
  --data_root "data/seg8k" \
  --model unet_min \
  --epochs 5 \
  --save_viz

# ä½¿ç”¨é…ç½®æ–‡ä»¶
python src/training/offline/train_offline_universal.py \
  --cfg configs/universal_template_config.yaml \
  --data_root "data/seg8k"
```

### è¾“å‡ºç»“æ„
```
outputs/
â””â”€â”€ your_model_20250822_143052/
    â”œâ”€â”€ config.json                 # è®­ç»ƒé…ç½®
    â”œâ”€â”€ metrics.csv                 # è®­ç»ƒæŒ‡æ ‡è®°å½•
    â”œâ”€â”€ checkpoints/                # æ¨¡å‹æ£€æŸ¥ç‚¹
    â””â”€â”€ visualizations/             # å¯è§†åŒ–ç»“æœ
```

### å•è¡Œå®Œæ•´å‘½ä»¤ï¼ˆtrain_offline_min.pyä¸ºä¾‹ï¼‰
python src/training/offline/train_offline_min.py --data_root "data/seg8k" --model_type "baseline_monitored" --img_size 512 --batch_size 6 --epochs 3 --lr 3e-4 --num_classes 2 --val_ratio 0.2 --save_viz --monitor_interval 5 --enable_gpu_monitor --num_workers 4

### äºŒåˆ†ç±»/å¤šåˆ†ç±»é€šç”¨è®­ç»ƒå‘½ä»¤
```bash
# äºŒåˆ†ç±»è®­ç»ƒ
python src/training/offline/train_offline_universal.py \
  --data_root "data/seg8k" \
  --binary \
  --model unet_min \
  --epochs 1 \
  --batch_size 2 \
  --img_size 256

# å¤šåˆ†ç±»è®­ç»ƒ
python src/training/offline/train_offline_universal.py \
  --data_root "data/seg8k" \
  --model adaptive_unet \
  --num_classes 3 \
  --epochs 5 \
  --batch_size 4 \
  --img_size 512
```

## ğŸ”§ ç›‘æ§æ¨¡å—é›†æˆæŒ‡å—

### train_offline_min.py é›†æˆæ­¥éª¤

#### 1. å¯¼å…¥ç›‘æ§æ¨¡å—
```python
from src.common.train_monitor import TrainMonitor
```

#### 2. åˆå§‹åŒ–ç›‘æ§å™¨ï¼ˆåœ¨mainå‡½æ•°å¼€å§‹ï¼‰
```python
monitor = TrainMonitor(enable_gpu_monitor=True)
monitor.start_timing()
```

#### 3. æ·»åŠ å‘½ä»¤è¡Œå‚æ•°
```python
p.add_argument("--monitor_interval", type=int, default=5, help="Progress update interval")
p.add_argument("--enable_gpu_monitor", action='store_true', default=True, help="Enable GPU monitoring")
```

#### 4. è®­ç»ƒå¾ªç¯ä¸­æ·»åŠ å®æ—¶ç›‘æ§
```python
for batch_idx, (images, masks) in enumerate(train_loader):
    # ... è®­ç»ƒä»£ç  ...
    if batch_idx % args.monitor_interval == 0:
        monitor.print_progress(epoch+1, args.epochs, batch_idx+1, len(train_loader), {"loss": current_loss})
```

#### 5. Epochç»“æŸæ·»åŠ æ€»ç»“
```python
monitor.print_epoch_summary(epoch+1, {"loss": avg_train_loss}, val_metrics)
```

### é¢„æœŸç›‘æ§è¾“å‡º
```
Epoch 1/20 [66/1078] | loss: 0.4183 | CPU: 7.1% | GPU: 99% (7971/8188MB) | Time: 00:21:02 | ETA: 06:23:45
Epoch 1 Summary:
  Train - loss: 0.2456
  Val   - val_loss: 0.2234 | iou: 0.7234 | dice: 0.8156 | accuracy: 0.9123
--------------------------------------------------------------------------------
```

## ğŸ”§ æ¨¡å‹åŠ¨ç‰©å›­ä½¿ç”¨æŒ‡å—

### æ¨¡å‹æ³¨å†Œå’Œä½¿ç”¨
```python
from src.models.model_zoo import build_model

# æ„å»ºäºŒåˆ†ç±»æ¨¡å‹
model = build_model(
    model_name="unet_min",
    in_channels=3,
    out_channels=1,  # äºŒåˆ†ç±»
    binary=True
)

# æ„å»ºå¤šåˆ†ç±»æ¨¡å‹
model = build_model(
    model_name="adaptive_unet", 
    in_channels=3,
    out_channels=3,  # èƒŒæ™¯ + å™¨æ¢° + ç›®æ ‡å™¨å®˜
    binary=False
)
```

### æ”¯æŒçš„æ¨¡å‹ç±»å‹
- `unet_min`: åŸºç¡€U-Netæ¨¡å‹ï¼ˆsrc/models/baseline/unet_min.pyï¼‰
- `mobile_unet`: è½»é‡çº§ç§»åŠ¨ç«¯U-Netï¼ˆsrc/models/online/mobile_unet.pyï¼‰
- `adaptive_unet`: è‡ªé€‚åº”U-Netï¼ˆsrc/models/online/adaptive_unet.pyï¼‰

### Fallbackæœºåˆ¶
å½“æŒ‡å®šæ¨¡å‹ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨å›é€€åˆ°UNetMinåŸºç¡€æ¨¡å‹ï¼Œç¡®ä¿è®­ç»ƒç»§ç»­è¿›è¡Œã€‚

## å¼€å‘è·¯çº¿å›¾

### è¿‘æœŸç›®æ ‡ (å·²å®Œæˆ)
- âœ… åŸºç¡€è®­ç»ƒæ¡†æ¶
- âœ… ç›‘æ§å’Œå¯è§†åŒ–æ¨¡å—ï¼ˆåŒ…å«ETAæ—¶é—´é¢„ä¼°ï¼‰
- âœ… é€šç”¨è®­ç»ƒæ¨¡æ¿ï¼ˆæ”¯æŒäºŒåˆ†ç±»/å¤šåˆ†ç±»åˆ‡æ¢ï¼‰
- âœ… è¯„ä¼°æŒ‡æ ‡æ¨¡å—
- âœ… å®æ—¶è®­ç»ƒè¿›åº¦ç›‘æ§ï¼ˆæ—¶é—´ã€èµ„æºã€ETAï¼‰
- âœ… åˆ†å‰²å¯è§†åŒ–å·¥å…·ï¼ˆé¢œè‰²æ˜ å°„ã€å¯¹æ¯”å›¾ç”Ÿæˆï¼‰
- âœ… å…¨å±€å¸¸é‡å’Œé…ç½®ç®¡ç†ç³»ç»Ÿ
- âœ… å¤šç±»åˆ†å‰²æ¼”ç¤ºè„šæœ¬
- âœ… è½»é‡çº§MobileUNetæ¨¡å‹ï¼ˆæ·±åº¦å¯åˆ†ç¦»å·ç§¯ï¼‰
- âœ… è‡ªé€‚åº”UNetæ¨¡å‹ï¼ˆé€‚é…å™¨æœºåˆ¶ï¼‰
- âœ… åœ¨çº¿å­¦ä¹ å’Œè‡ªé€‚åº”ç³»ç»Ÿï¼ˆå¸§é€‰æ‹©ã€ç»éªŒå›æ”¾ã€å®æ—¶é€‚åº”ï¼‰
- âœ… æ¨¡å‹åŠ¨ç‰©å›­ç³»ç»Ÿï¼ˆç»Ÿä¸€æ¨¡å‹ç®¡ç†ã€æ’æ‹”æœºåˆ¶ã€Fallbackä¿æŠ¤ï¼‰
- âœ… è®­ç»ƒæ¨¡å—é‡ç»„ï¼ˆoffline/onlineåˆ†ç¦»ï¼‰

### ä¸­æœŸç›®æ ‡ (è®¡åˆ’ä¸­)
- ğŸ“‹ æ¨¡å‹è’¸é¦åŠŸèƒ½
- ğŸ“‹ å¤šæ•°æ®é›†æ”¯æŒ
- ğŸ“‹ æ¶ˆèå®éªŒå¥—ä»¶

### é•¿æœŸç›®æ ‡ (æœªæ¥)
- ğŸ“‹ å®æ—¶æ¨ç†ä¼˜åŒ–
- ğŸ“‹ æ¨¡å‹å‹ç¼©å’ŒåŠ é€Ÿ
- ğŸ“‹ äº‘ç«¯éƒ¨ç½²æ”¯æŒ
